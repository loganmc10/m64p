language: shell
addons:
  artifacts:
    paths:
    - $(ls $TRAVIS_BUILD_DIR/*.zip)
    - $(ls $TRAVIS_BUILD_DIR/*.dmg)
    target_paths:
    - /m64p
jobs:
  include:
  - stage: build-linux
    dist: bionic
    before_install:
    - sudo apt-get -qq update
    - sudo apt-get -y dist-upgrade
    - sudo apt-get -y install cmake libhidapi-dev lsb-release wget libminizip-dev libsdl2-dev libfreetype6-dev libgl1-mesa-dev libglu1-mesa-dev pkg-config zlib1g-dev binutils-dev libspeexdsp-dev libsamplerate0-dev qt5-default build-essential nasm git zip libsdl2-net-dev libqt5websockets5-dev
    script:
    - bash ./build.sh
  - stage: build-windows
    env:
    - MSYSTEM=MINGW64
    - myarch=x86_64
    - MSYS2_DIR=msys64
    os: windows
    before_install:
    - "[[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64"
    - choco uninstall -y mingw
    - choco upgrade --no-progress -y msys2
    - export msys2='cmd //C RefreshEnv.cmd '
    - export msys2+='& set MSYS=winsymlinks:nativestrict '
    - export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
    - export mingw64="$msys2 -mingw64 -full-path -here -c "\"\$@"\" --"
    - export msys2+=" -msys2 -c "\"\$@"\" --"
    - $msys2 pacman --sync --noconfirm --needed mingw-w64-x86_64-toolchain
    - taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
    - export PATH=/C/tools/msys64/mingw64/bin:$PATH
    - export MAKE=mingw32-make  # so that Autotools can find it
    script:
    - $msys2 pacman -Syu --noconfirm
    - $msys2 pacman -Syu --noconfirm
    - $msys2 pacman -S --needed --noconfirm make mingw-w64-$myarch-cmake mingw-w64-$myarch-gcc mingw-w64-$myarch-hidapi mingw-w64-$myarch-freetype mingw-w64-$myarch-libpng mingw-w64-$myarch-libsamplerate mingw-w64-$myarch-SDL2 mingw-w64-$myarch-SDL2_net mingw-w64-$myarch-jasper mingw-w64-$myarch-qt5 mingw-w64-$myarch-python3-pip mingw-w64-$myarch-python3-pyopenssl zip
    - export HOST_CPU=$myarch; $mingw64 ./build.sh
    before_cache:
    - $msys2 pacman --sync --clean --noconfirm
    cache:
      directories:
      - $HOME/AppData/Local/Temp/chocolatey
      - /C/tools/msys64
